<div class="results-container" *ngIf="results; else noResults">
  <!-- Overview Metrics -->
  <div class="metrics-grid">
    <mat-card class="metric-card">
      <div
        class="metric-value"
        [class.positive]="(results.metrics.total_profit_money || 0) > 0"
        [class.negative]="(results.metrics.total_profit_money || 0) < 0"
      >
        {{
          results.metrics.total_profit_money
            | currency : "USD" : "symbol" : "1.0-0"
        }}
      </div>
      <div class="metric-label">Total Profit</div>
    </mat-card>

    <mat-card class="metric-card">
      <div class="metric-value neutral">{{ results.metrics.win_rate }}%</div>
      <div class="metric-label">Win Rate</div>
    </mat-card>

    <mat-card class="metric-card">
      <div class="metric-value neutral">{{ getNetReturn() }}%</div>
      <div class="metric-label">Net Return</div>
    </mat-card>

    <mat-card class="metric-card">
      <div class="metric-value neutral">
        {{ results.metrics.profit_factor }}
      </div>
      <div class="metric-label">Profit Factor</div>
    </mat-card>

    <mat-card class="metric-card">
      <div class="metric-value negative">
        {{ results.metrics.max_drawdown_percent }}%
      </div>
      <div class="metric-label">Max Drawdown</div>
    </mat-card>

    <mat-card class="metric-card">
      <div class="metric-value positive">
        {{
          results.metrics.avg_win_money | currency : "USD" : "symbol" : "1.0-0"
        }}
      </div>
      <div class="metric-label">Avg Win ($)</div>
    </mat-card>

    <mat-card class="metric-card">
      <div class="metric-value negative">
        {{
          results.metrics.avg_loss_money | currency : "USD" : "symbol" : "1.0-0"
        }}
      </div>
      <div class="metric-label">Avg Loss ($)</div>
    </mat-card>
  </div>

  <!-- Premium Trade Summary Report -->
  <mat-card class="summary-report-card glass-panel mb-16">
    <mat-card-header>
      <mat-card-title class="text-gradient"
        >üìä Trade Summary Report</mat-card-title
      >
      <button mat-raised-button color="primary" (click)="copyReport()">
        <mat-icon>content_copy</mat-icon>
        Copy Report
      </button>
    </mat-card-header>
    <mat-card-content>
      <div class="summary-grid">
        <div class="summary-section">
          <h3>üìà TRADE SUMMARY</h3>
          <div class="summary-item">
            <span class="label">Started Balance:</span>
            <span class="value">{{
              results.metrics.initial_balance
                | currency : "USD" : "symbol" : "1.0-0"
            }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Final Balance:</span>
            <span class="value accent">{{
              results.metrics.final_balance
                | currency : "USD" : "symbol" : "1.2-2"
            }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Total Profit:</span>
            <span
              class="value"
              [class.positive]="(results.metrics.total_profit_money || 0) > 0"
              [class.negative]="(results.metrics.total_profit_money || 0) < 0"
            >
              {{
                results.metrics.total_profit_money
                  | currency : "USD" : "symbol" : "1.2-2"
              }}
            </span>
          </div>
          <div class="summary-item">
            <span class="label">Total Signals:</span>
            <span class="value">{{ results.metrics.total_trades }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Closed Trades:</span>
            <span class="value">{{ results.metrics.closed_trades }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Open Trades:</span>
            <span class="value">{{ results.metrics.open_trades }}</span>
          </div>
        </div>

        <div class="summary-section">
          <h3>üí∞ P&L METRICS</h3>
          <div class="summary-item">
            <span class="label">Total Pips:</span>
            <span class="value accent">{{ results.metrics.total_pips }}</span>
          </div>
          <div class="summary-row">
            <div class="summary-item">
              <span class="label">Winning Trades:</span>
              <span class="value positive"
                >{{ results.metrics.winning_trades }} ‚úÖ</span
              >
            </div>
            <div class="summary-item">
              <span class="label">Losing Trades:</span>
              <span class="value negative"
                >{{ results.metrics.losing_trades }} ‚ùå</span
              >
            </div>
          </div>
          <div class="summary-row">
            <div class="summary-item">
              <span class="label">Avg Win:</span>
              <span class="value positive"
                >{{ results.metrics.avg_win }} pips</span
              >
            </div>
            <div class="summary-item">
              <span class="label">Avg Loss:</span>
              <span class="value negative"
                >{{ results.metrics.avg_loss }} pips</span
              >
            </div>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Tabs for detailed views -->
  <mat-tab-group>
    <!-- Charts Tab -->
    <mat-tab label="Analytics Charts">
      <div class="tab-content charts-grid">
        <mat-card class="glass-panel chart-card">
          <mat-card-header>
            <mat-card-title>Equity Growth (%)</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="chart-container">
              <canvas
                baseChart
                [data]="equityChartData"
                [options]="equityChartOptions"
                type="line"
              >
              </canvas>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card
          class="glass-panel chart-card"
          *ngIf="results.monthly_performance"
        >
          <mat-card-header>
            <mat-card-title>Monthly Percent Return</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="chart-container">
              <canvas
                baseChart
                [data]="monthlyChartData"
                [options]="monthlyChartOptions"
                type="bar"
              >
              </canvas>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </mat-tab>

    <!-- Trades Tab -->
    <mat-tab label="All Trades">
      <div class="tab-content">
        <mat-card>
          <mat-card-header>
            <mat-card-title>Trade History</mat-card-title>
            <button mat-raised-button color="primary" (click)="exportToCSV()">
              <mat-icon>download</mat-icon>
              Export CSV
            </button>
          </mat-card-header>
          <mat-card-content>
            <div class="table-container">
              <table
                mat-table
                [dataSource]="results.trades"
                class="trades-table"
              >
                <ng-container matColumnDef="timestamp">
                  <th mat-header-cell *matHeaderCellDef>Timestamp</th>
                  <td mat-cell *matCellDef="let trade">
                    {{ trade.timestamp | date : "short" }}
                  </td>
                </ng-container>

                <ng-container matColumnDef="type">
                  <th mat-header-cell *matHeaderCellDef>Type</th>
                  <td mat-cell *matCellDef="let trade">
                    <span
                      class="trade-type"
                      [class.buy]="trade.type === 'BUY'"
                      [class.sell]="trade.type === 'SELL'"
                    >
                      {{ trade.type }}
                    </span>
                  </td>
                </ng-container>

                <ng-container matColumnDef="entry_price">
                  <th mat-header-cell *matHeaderCellDef>Entry</th>
                  <td mat-cell *matCellDef="let trade">
                    {{ trade.entry_price | number : "1.2-2" }}
                  </td>
                </ng-container>

                <ng-container matColumnDef="sl">
                  <th mat-header-cell *matHeaderCellDef>SL</th>
                  <td mat-cell *matCellDef="let trade">
                    {{ trade.sl | number : "1.2-2" }}
                  </td>
                </ng-container>

                <ng-container matColumnDef="tp">
                  <th mat-header-cell *matHeaderCellDef>TP</th>
                  <td mat-cell *matCellDef="let trade">
                    {{ trade.tp | number : "1.2-2" }}
                  </td>
                </ng-container>

                <ng-container matColumnDef="close_price">
                  <th mat-header-cell *matHeaderCellDef>Close</th>
                  <td mat-cell *matCellDef="let trade">
                    {{
                      trade.close_price
                        ? (trade.close_price | number : "1.2-2")
                        : "-"
                    }}
                  </td>
                </ng-container>

                <ng-container matColumnDef="pips">
                  <th mat-header-cell *matHeaderCellDef>Pips</th>
                  <td mat-cell *matCellDef="let trade">
                    <span [ngClass]="getTradeClass(trade)">
                      {{
                        trade.pips !== null
                          ? (trade.pips | number : "1.2-2")
                          : "-"
                      }}
                    </span>
                  </td>
                </ng-container>

                <ng-container matColumnDef="confidence">
                  <th mat-header-cell *matHeaderCellDef>Confidence</th>
                  <td mat-cell *matCellDef="let trade">
                    {{ trade.confidence * 100 | number : "1.0-0" }}%
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr
                  mat-row
                  *matRowDef="let row; columns: displayedColumns"
                ></tr>
              </table>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </mat-tab>
  </mat-tab-group>
</div>

<ng-template #noResults>
  <div class="no-results">
    <mat-icon>info</mat-icon>
    <h2>No Results Available</h2>
    <p>Run a backtest to see results here.</p>
  </div>
</ng-template>
