<div class="strategies-container">
  <div class="header-row">
    <h2>
      <mat-icon
        color="primary"
        style="vertical-align: middle; margin-right: 8px"
        >military_tech</mat-icon
      >Top Strategies
    </h2>
    <button mat-icon-button (click)="loadStrategies()" [disabled]="loading">
      <mat-icon>refresh</mat-icon>
    </button>
  </div>

  <div class="table-container">
    <div class="loading-shade" *ngIf="loading">
      <mat-spinner diameter="40"></mat-spinner>
    </div>

    <table
      mat-table
      [dataSource]="strategies"
      class="strategy-table"
      *ngIf="strategies.length > 0"
    >
      <!-- Name Column -->
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef>Strategy Name</th>
        <td mat-cell *matCellDef="let strategy">
          <span class="strategy-name">{{ strategy.name }}</span>
          <mat-icon
            *ngIf="isTopPerformer(strategy)"
            class="premium-badge"
            matTooltip="Top Performer"
            >verified</mat-icon
          >
        </td>
      </ng-container>

      <!-- Gain Percent Column -->
      <ng-container matColumnDef="gainPercent">
        <th mat-header-cell *matHeaderCellDef>Gain (%)</th>
        <td mat-cell *matCellDef="let strategy">
          <span
            class="metric-chip"
            [ngClass]="strategy.gain_percent >= 0 ? 'positive' : 'negative'"
          >
            {{ strategy.gain_percent > 0 ? "+" : ""
            }}{{ strategy.gain_percent | number : "1.2-2" }}%
          </span>
        </td>
      </ng-container>

      <!-- Metric (Sparkline) Column -->
      <ng-container matColumnDef="metric">
        <th mat-header-cell *matHeaderCellDef>Overall Metric</th>
        <td mat-cell *matCellDef="let strategy">
          <div class="sparkline-container">
            <canvas
              baseChart
              [data]="strategy.chartData"
              [options]="sparklineOptions"
              [type]="'line'"
            ></canvas>
          </div>
        </td>
      </ng-container>

      <!-- Trades Column -->
      <ng-container matColumnDef="trades">
        <th mat-header-cell *matHeaderCellDef>Trades</th>
        <td mat-cell *matCellDef="let strategy">
          {{ strategy.backtest.metrics.total_trades }}
        </td>
      </ng-container>

      <!-- Win Rate Column -->
      <ng-container matColumnDef="winRate">
        <th mat-header-cell *matHeaderCellDef>Win Rate</th>
        <td mat-cell *matCellDef="let strategy">
          <span
            class="metric-chip"
            [ngClass]="
              strategy.backtest.metrics.win_rate >= 50 ? 'positive' : 'negative'
            "
          >
            {{ strategy.backtest.metrics.win_rate }}%
          </span>
        </td>
      </ng-container>

      <!-- Profit Factor Column -->
      <ng-container matColumnDef="profitFactor">
        <th mat-header-cell *matHeaderCellDef>Profit Factor</th>
        <td mat-cell *matCellDef="let strategy">
          {{ strategy.backtest.metrics.profit_factor }}
        </td>
      </ng-container>

      <!-- Age Column -->
      <ng-container matColumnDef="age">
        <th mat-header-cell *matHeaderCellDef>Age (Days)</th>
        <td mat-cell *matCellDef="let strategy">
          {{ strategy.backtest.metrics.period_days || "N/A" }}
        </td>
      </ng-container>

      <!-- Connected Clients Column -->
      <ng-container matColumnDef="connectedClients">
        <th mat-header-cell *matHeaderCellDef>Connected Clients</th>
        <td mat-cell *matCellDef="let strategy">
          <div style="display: flex; align-items: center; gap: 8px">
            <mat-icon style="font-size: 18px; width: 18px; height: 18px"
              >group</mat-icon
            >
            {{ strategy.connectedClients }}
          </div>
        </td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let strategy">
          <div style="display: flex; align-items: center; gap: 12px">
            <button mat-button (click)="onDetail(strategy)" class="detail-btn">
              <mat-icon>analytics</mat-icon>
              Details
            </button>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr
        mat-row
        *matRowDef="let row; columns: displayedColumns"
        [ngClass]="{ 'premium-performer': isTopPerformer(row) }"
      ></tr>
    </table>

    <div class="no-data-msg" *ngIf="!loading && strategies.length === 0">
      <mat-icon>history</mat-icon>
      <p>No strategies found. Train and backtest a model to see it here.</p>
    </div>
  </div>
</div>
